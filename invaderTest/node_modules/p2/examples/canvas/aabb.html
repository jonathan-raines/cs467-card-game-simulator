<!DOCTYPE html>
<html lang="en">
  <head>
    <title>p2.js aabb perf test</title>
    <meta charset="utf-8">
    <script src="../../build/p2.js"></script>
  </head>
  <body>

    <script>
      var world, boxBody, planeBody, N=100;

            var shouldersDistance = 0.5,
                upperArmLength = 0.4,
                lowerArmLength = 0.4,
                upperArmSize = 0.2,
                lowerArmSize = 0.2,
                neckLength = 0.1,
                headRadius = 0.25,
                upperBodyLength = 0.6,
                pelvisLength = 0.4,
                upperLegLength = 0.5,
                upperLegSize = 0.2,
                lowerLegSize = 0.2,
                lowerLegLength = 0.5;
      init();
      animate();

      function init(){

            // Init p2.js
            world = new p2.World();

            var OTHER =     Math.pow(2,1),
                BODYPARTS = Math.pow(2,2),
                WALLS =     Math.pow(2,3),
                bodyPartShapes = [];


                var headShape = new p2.Circle({ radius: headRadius }),
                    upperArmShapeLeft = new p2.Box({ width: upperArmLength, height: upperArmSize }),
                    upperArmShapeRight = new p2.Box({ width: upperArmLength, height: upperArmSize }),
                    lowerArmShapeLeft = new p2.Box({ width: lowerArmLength, height: lowerArmSize }),
                    lowerArmShapeRight = new p2.Box({ width: lowerArmLength, height: lowerArmSize }),
                    upperBodyShape = new p2.Box({ width: shouldersDistance, height: upperBodyLength }),
                    pelvisShape = new p2.Box({ width: shouldersDistance, height: pelvisLength }),
                    upperLegShapeLeft = new p2.Box({ width: upperLegSize, height: upperLegLength }),
                    upperLegShapeRight = new p2.Box({ width: upperLegSize, height: upperLegLength }),
                    lowerLegShapeLeft = new p2.Box({ width: lowerLegSize, height: lowerLegLength }),
                    lowerLegShapeRight = new p2.Box({ width: lowerLegSize, height: lowerLegLength });

                bodyPartShapes.push(
                    headShape,
                    upperArmShapeRight,
                    upperArmShapeLeft,
                    lowerArmShapeRight,
                    lowerArmShapeLeft,
                    upperBodyShape,
                    pelvisShape,
                    upperLegShapeRight,
                    upperLegShapeLeft,
                    lowerLegShapeRight,
                    lowerLegShapeLeft
                );

                for(var i=0; i<bodyPartShapes.length; i++){
                    var s = bodyPartShapes[i];
                    s.collisionGroup = BODYPARTS;
                    s.collisionMask = OTHER|WALLS;
                }

                world.solver.iterations = 100;
                world.solver.tolerance = 0.002;

                // Lower legs
                lowerLeftLeg = new p2.Body({
                    mass: 1,
                    position: [-shouldersDistance/2,lowerLegLength / 2],
                });
                lowerRightLeg = new p2.Body({
                    mass: 1,
                    position: [shouldersDistance/2,lowerLegLength / 2],
                });
                lowerLeftLeg.addShape(lowerLegShapeLeft);
                lowerRightLeg.addShape(lowerLegShapeRight);
                world.addBody(lowerLeftLeg);
                world.addBody(lowerRightLeg);

                // Upper legs
                var upperLeftLeg = new p2.Body({
                    mass: 1,
                    position: [-shouldersDistance/2,lowerLeftLeg.position[1]+lowerLegLength/2+upperLegLength / 2],
                });
                var upperRightLeg = new p2.Body({
                    mass: 1,
                    position: [shouldersDistance/2,lowerRightLeg.position[1]+lowerLegLength/2+upperLegLength / 2],
                });
                upperLeftLeg.addShape(upperLegShapeLeft);
                upperRightLeg.addShape(upperLegShapeRight);
                world.addBody(upperLeftLeg);
                world.addBody(upperRightLeg);

                // Pelvis
                pelvis = new p2.Body({
                    mass: 1,
                    position: [0, upperLeftLeg.position[1]+upperLegLength/2+pelvisLength/2],
                });
                pelvis.addShape(pelvisShape);
                world.addBody(pelvis);

                // Upper body
                var upperBody = new p2.Body({
                    mass: 1,
                    position: [0,pelvis.position[1]+pelvisLength/2+upperBodyLength/2],
                });
                upperBody.addShape(upperBodyShape);
                world.addBody(upperBody);

                // Head
                var head = new p2.Body({
                    mass: 1,
                    position: [0,upperBody.position[1]+upperBodyLength/2+headRadius+neckLength],
                });
                head.addShape(headShape);
                world.addBody(head);

                // Upper arms
                var upperLeftArm = new p2.Body({
                    mass: 1,
                    position: [-shouldersDistance/2-upperArmLength/2, upperBody.position[1]+upperBodyLength/2],
                });
                var upperRightArm = new p2.Body({
                    mass: 1,
                    position: [shouldersDistance/2+upperArmLength/2, upperBody.position[1]+upperBodyLength/2],
                });
                upperLeftArm.addShape(upperArmShapeLeft);
                upperRightArm.addShape(upperArmShapeRight);
                world.addBody(upperLeftArm);
                world.addBody(upperRightArm);

                // lower arms
                lowerLeftArm = new p2.Body({
                    mass: 1,
                    position: [ upperLeftArm.position[0] - lowerArmLength/2 - upperArmLength/2,
                                upperLeftArm.position[1]],
                });
                lowerRightArm = new p2.Body({
                    mass: 1,
                    position: [ upperRightArm.position[0] + lowerArmLength/2 + upperArmLength/2,
                                upperRightArm.position[1]],
                });
                lowerLeftArm.addShape(lowerArmShapeLeft);
                lowerRightArm.addShape(lowerArmShapeRight);
                world.addBody(lowerLeftArm);
                world.addBody(lowerRightArm);


                // Neck joint
                var neckJoint = new p2.RevoluteConstraint(head, upperBody, {
                    localPivotA: [0,-headRadius-neckLength/2],
                    localPivotB: [0,upperBodyLength/2],
                });
                neckJoint.setLimits(-Math.PI / 8, Math.PI / 8);
                world.addConstraint(neckJoint);

                // Knee joints
                var leftKneeJoint = new p2.RevoluteConstraint(lowerLeftLeg, upperLeftLeg, {
                    localPivotA: [0, lowerLegLength/2],
                    localPivotB: [0,-upperLegLength/2],
                });
                var rightKneeJoint= new p2.RevoluteConstraint(lowerRightLeg, upperRightLeg, {
                    localPivotA: [0, lowerLegLength/2],
                    localPivotB:[0,-upperLegLength/2],
                });
                leftKneeJoint.setLimits(-Math.PI / 8, Math.PI / 8);
                rightKneeJoint.setLimits(-Math.PI / 8, Math.PI / 8);
                world.addConstraint(leftKneeJoint);
                world.addConstraint(rightKneeJoint);

                // Hip joints
                var leftHipJoint = new p2.RevoluteConstraint(upperLeftLeg, pelvis, {
                    localPivotA: [0, upperLegLength/2],
                    localPivotB: [-shouldersDistance/2,-pelvisLength/2],
                });
                var rightHipJoint = new p2.RevoluteConstraint(upperRightLeg, pelvis, {
                    localPivotA: [0, upperLegLength/2],
                    localPivotB: [shouldersDistance/2,-pelvisLength/2],
                });
                leftHipJoint.setLimits(-Math.PI / 8, Math.PI / 8);
                rightHipJoint.setLimits(-Math.PI / 8, Math.PI / 8);
                world.addConstraint(leftHipJoint);
                world.addConstraint(rightHipJoint);

                // Spine
                var spineJoint = new p2.RevoluteConstraint(pelvis, upperBody, {
                    localPivotA: [0,pelvisLength/2],
                    localPivotB: [0,-upperBodyLength/2],
                });
                spineJoint.setLimits(-Math.PI / 8, Math.PI / 8);
                world.addConstraint(spineJoint);

                // Shoulders
                var leftShoulder = new p2.RevoluteConstraint(upperBody, upperLeftArm, {
                    localPivotA:[-shouldersDistance/2, upperBodyLength/2],
                    localPivotB:[upperArmLength/2,0],
                });
                var rightShoulder= new p2.RevoluteConstraint(upperBody, upperRightArm, {
                    localPivotA:[shouldersDistance/2,  upperBodyLength/2],
                    localPivotB:[-upperArmLength/2,0],
                });
                leftShoulder.setLimits(-Math.PI / 3, Math.PI / 3);
                rightShoulder.setLimits(-Math.PI / 3, Math.PI / 3);
                world.addConstraint(leftShoulder);
                world.addConstraint(rightShoulder);

                // Elbow joint
                var leftElbowJoint = new p2.RevoluteConstraint(lowerLeftArm, upperLeftArm, {
                    localPivotA: [lowerArmLength/2, 0],
                    localPivotB: [-upperArmLength/2,0],
                });
                var rightElbowJoint= new p2.RevoluteConstraint(lowerRightArm, upperRightArm, {
                    localPivotA:[-lowerArmLength/2,0],
                    localPivotB:[upperArmLength/2,0],
                });
                leftElbowJoint.setLimits(-Math.PI / 8, Math.PI / 8);
                rightElbowJoint.setLimits(-Math.PI / 8, Math.PI / 8);
                world.addConstraint(leftElbowJoint);
                world.addConstraint(rightElbowJoint);

            // Create ground
            var groundShape = new p2.Plane();
            var ground = new p2.Body({
                position:[0,-1],
            });
            ground.addShape(groundShape);
            groundShape.collisionGroup = WALLS;
            groundShape.collisionMask =  BODYPARTS|OTHER;
            world.addBody(ground);

            //create walls
            var leftWallShape = new p2.Plane();
            var leftWall = new p2.Body({
                position:[-8,0],
                angle:[3*Math.PI/2]
            });

            leftWall.addShape(leftWallShape);
            leftWallShape.collisionGroup = WALLS;
            leftWallShape.collisionMask =  BODYPARTS|OTHER;
            world.addBody(leftWall);

            var rightWallShape = new p2.Plane();
            var rightWall = new p2.Body({
                position:[8,0],
                angle:[Math.PI/2]
            });

            rightWall.addShape(rightWallShape);
            rightWallShape.collisionGroup = WALLS;
            rightWallShape.collisionMask =  BODYPARTS|OTHER;
            world.addBody(rightWall);

            var topWallShape = new p2.Plane();
            var topWall = new p2.Body({
                position:[0,10],
                angle:[Math.PI]
            });

            topWall.addShape(topWallShape);
            topWallShape.collisionGroup = WALLS;
            topWallShape.collisionMask =  BODYPARTS|OTHER;
            world.addBody(topWall);
      }

      // Animation loop
      function animate(){
        requestAnimationFrame(animate);

        // Move physics bodies forward in time
        for(var i=0; i<N; i++)
          world.step(1 / 60);
      }
    </script>

  </body>
</html>
